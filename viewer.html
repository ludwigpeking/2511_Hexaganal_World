<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Quad Map Viewer</title>
        <script src="vertexClass.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #f0f0f0;
            }
            h1 {
                color: #333;
            }
            #controls {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }
            button {
                padding: 10px 20px;
                margin: 5px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
            button:hover {
                background: #45a049;
            }
            #canvas-container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                display: inline-block;
            }
            canvas {
                border: 1px solid #ddd;
            }
            #info {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-top: 20px;
                font-size: 14px;
            }
            #info h3 {
                margin-top: 0;
            }
            .stat-row {
                margin: 5px 0;
            }
            .stat-label {
                font-weight: bold;
                display: inline-block;
                width: 150px;
            }
        </style>
    </head>
    <body>
        <h1>üó∫Ô∏è Quadrangulated Map Viewer</h1>

        <div id="controls">
            <input type="file" id="fileInput" accept=".json" />
            <button onclick="loadMapFromFile()">Load Map</button>
            <button onclick="toggleFill()">Toggle Fill</button>
            <button onclick="toggleNeighbors()">Highlight Neighbors</button>
            <button onclick="exportCanvas()">Export PNG</button>
        </div>

        <div id="canvas-container">
            <canvas id="mapCanvas" width="1200" height="1200"></canvas>
        </div>

        <div id="info">
            <h3>Map Information</h3>
            <div id="stats">No map loaded. Please load a JSON file.</div>
        </div>

        <script>
            let mapData = null;
            let canvas = document.getElementById("mapCanvas");
            let ctx = canvas.getContext("2d");
            let fillEnabled = true;
            let selectedTile = null;

            function loadMapFromFile() {
                const fileInput = document.getElementById("fileInput");
                const file = fileInput.files[0];

                if (!file) {
                    alert("Please select a file first");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        mapData = JSON.parse(e.target.result);
                        displayMap();
                        displayInfo();
                    } catch (error) {
                        alert("Error loading map: " + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function displayMap() {
                if (!mapData) return;

                // Clear canvas
                ctx.fillStyle = "#f5f5f5";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Scale coordinates from 800x800 to current canvas size
                const scale = canvas.width / 800;
                ctx.save();
                ctx.scale(scale, scale);

                // First, highlight neighbors if a tile is selected
                if (selectedTile !== null) {
                    const tile = mapData.tiles[selectedTile];
                    tile.neighbors.forEach((neighborId) => {
                        drawTileHighlight(
                            mapData.tiles[neighborId],
                            "rgba(255, 165, 0, 0.8)",
                            3
                        );
                    });
                }

                // Then draw all tiles
                mapData.tiles.forEach((tile, idx) => {
                    drawTile(tile, idx === selectedTile);
                });

                ctx.restore();
            }

            function drawTileHighlight(tile, color, lineWidth) {
                if (tile.vertices.length < 3) return;

                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.fillStyle = color.replace("0.8)", "0.3)"); // Make fill semi-transparent

                ctx.beginPath();
                ctx.moveTo(tile.vertices[0].x, tile.vertices[0].y);
                for (let i = 1; i < tile.vertices.length; i++) {
                    ctx.lineTo(tile.vertices[i].x, tile.vertices[i].y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            function drawTile(tile, isSelected) {
                if (tile.vertices.length < 3) return;

                ctx.beginPath();
                ctx.moveTo(tile.vertices[0].x, tile.vertices[0].y);

                for (let i = 1; i < tile.vertices.length; i++) {
                    ctx.lineTo(tile.vertices[i].x, tile.vertices[i].y);
                }

                ctx.closePath();

                // Fill
                if (fillEnabled) {
                    if (isSelected) {
                        ctx.fillStyle = "rgba(255, 100, 100, 0.3)";
                    } else {
                        ctx.fillStyle = "rgba(200, 200, 200, 0.2)";
                    }
                    ctx.fill();
                }

                // Stroke
                ctx.strokeStyle = isSelected ? "#ff0000" : "#333333";
                ctx.lineWidth = isSelected ? 2 : 0.5;
                ctx.stroke();

                // Draw center point for selected tile
                if (isSelected) {
                    ctx.fillStyle = "#ff0000";
                    ctx.beginPath();
                    ctx.arc(tile.center.x, tile.center.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function displayInfo() {
                if (!mapData) return;

                const areas = mapData.tiles.map((t) => t.area);
                const neighborCounts = mapData.tiles.map(
                    (t) => t.neighbors.length
                );

                const stats = `
                <div class="stat-row">
                    <span class="stat-label">Total Tiles:</span>
                    <span>${mapData.tiles.length}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Vertices:</span>
                    <span>${
                        mapData.vertices ? mapData.vertices.length : "N/A"
                    }</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Area:</span>
                    <span>${(
                        areas.reduce((a, b) => a + b) / areas.length
                    ).toFixed(2)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Min/Max Area:</span>
                    <span>${Math.min(...areas).toFixed(2)} / ${Math.max(
                    ...areas
                ).toFixed(2)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Neighbors:</span>
                    <span>${(
                        neighborCounts.reduce((a, b) => a + b) /
                        neighborCounts.length
                    ).toFixed(2)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Random Seed:</span>
                    <span>${mapData.params.randomSeed}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hex Ring Count:</span>
                    <span>${mapData.params.hexRingCount}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Relaxation Iterations:</span>
                    <span>${mapData.params.relaxationIterations}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Relaxation Strength:</span>
                    <span>${mapData.params.relaxationStrength}</span>
                </div>
            `;

                document.getElementById("stats").innerHTML = stats;
            }

            function toggleFill() {
                fillEnabled = !fillEnabled;
                displayMap();
            }

            function toggleNeighbors() {
                // Click on a tile to highlight its neighbors
                alert(
                    "Click on a tile in the canvas to highlight its neighbors"
                );
            }

            function exportCanvas() {
                if (!mapData) {
                    alert("No map loaded");
                    return;
                }

                const link = document.createElement("a");
                link.download = "quadmap_viewer_export.png";
                link.href = canvas.toDataURL();
                link.click();
            }

            // Click handler for tile selection
            canvas.addEventListener("click", function (e) {
                if (!mapData) return;

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Scale click coordinates back to original 800x800 coordinate system
                const scale = 800 / canvas.width;
                const scaledX = x * scale;
                const scaledY = y * scale;

                // Find clicked tile
                for (let i = 0; i < mapData.tiles.length; i++) {
                    const tile = mapData.tiles[i];
                    if (isPointInTile(scaledX, scaledY, tile)) {
                        selectedTile = i;
                        displayMap();

                        // Show tile info with vertices
                        const vertexInfo = tile.vertices
                            .map((v) => {
                                const vertexData = mapData.vertices
                                    ? mapData.vertices[v.index]
                                    : null;
                                const neighborCount = vertexData
                                    ? vertexData.neighbors.length
                                    : "N/A";
                                return `<div style="margin-left: 20px;">Vertex ${v.index}: ${neighborCount} neighbors</div>`;
                            })
                            .join("");

                        const tileInfo = `
                        <h4>Tile ${tile.id} Selected</h4>
                        <div class="stat-row">
                            <span class="stat-label">Center:</span>
                            <span>(${tile.center.x.toFixed(
                                1
                            )}, ${tile.center.y.toFixed(1)})</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Area:</span>
                            <span>${tile.area.toFixed(2)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Neighbors:</span>
                            <span>${tile.neighbors.join(", ")}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Vertices:</span>
                        </div>
                        ${vertexInfo}
                    `;

                        const infoDiv = document.getElementById("info");
                        infoDiv.innerHTML = tileInfo + infoDiv.innerHTML;
                        return;
                    }
                }

                // Deselect if clicked outside
                selectedTile = null;
                displayMap();
            });

            function isPointInTile(x, y, tile) {
                // Ray casting algorithm for point-in-polygon
                let inside = false;
                const vertices = tile.vertices;

                for (
                    let i = 0, j = vertices.length - 1;
                    i < vertices.length;
                    j = i++
                ) {
                    const xi = vertices[i].x,
                        yi = vertices[i].y;
                    const xj = vertices[j].x,
                        yj = vertices[j].y;

                    const intersect =
                        yi > y !== yj > y &&
                        x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
                    if (intersect) inside = !inside;
                }

                return inside;
            }

            // Initial message
            ctx.font = "20px Arial";
            ctx.fillStyle = "#666";
            ctx.textAlign = "center";
            ctx.fillText(
                "Load a map JSON file to begin",
                canvas.width / 2,
                canvas.height / 2
            );
        </script>
    </body>
</html>
